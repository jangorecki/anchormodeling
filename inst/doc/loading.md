# Design notes for am$load method:

- [ ] loading model unit tests:
  - [ ] one flat data
  - [ ] two flat data
  - [ ] multiple flat data
- [x] ETL template:
  - [x] isolate IM - loading anchors/knots ID only
    - [x] lookup anchor PK from local IM table to incoming data
    - [x] generate new PK for new rows
    - [x] write new rows to IM
    - [x] include just im$use()
  - [x] isolate single anchor loading: model processing of single anchor load as atomic operation
    - [x] as easy as lapply
    - [ ] make it parallel
- [ ] loading process
  - [ ] two pass: detailed validation in first loop
  - [ ] AM$load
    - [x] unique names `length(names(data))==uniqueN(names(data))`
    - [x] model-mapping validation
      - [x] multiple *exists*/*valid* checks
        - [x] any nested element with `"" / NULL / hist` name must exists in incoming data
    - [x] surrogate key gen function based on nk
    - [x] check NK (provide by anchor and *src cols*)
      - [x] exists in incoming data
      - [x] exists in currently using mapping
    - [x] prepare sequence of loading
      - [x] knots
      - [x] anchors
        - [x] attributes
      - [ ] ties
    - [x] child classes related validation
    - [x] call $load.AMobj just with a subset of cols
    - [x] rename *src cols* to *tbl cols*
    - [x] add metadata id
    - [x] add metadata src + auto (using deparse-substitute on dataset variable name)
    - [x] add metadata user + auto
  - [x] AMobj$load
    - [x] validate nrow
    - [x] data types validation - except first load
    - [ ] PK and new data value violation for static attributes
    - [ ] restatement + idempotency
    - [x] append log
  - [x] AMobj$insert
    - [x] rbindlist
    - [x] resetkey
- [ ] rollback based on metadata ID delete from all
  - [ ] new method for delete data by meta id from all tables
- [ ] create indexes after insert
